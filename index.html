<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼Šæ–¯å¦å ¡å…¨èƒ½åš®å°</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 3. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 4. Leaflet CSS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- 5. Leaflet JS (Map) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- 6. SortableJS (Drag & Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'turk-red': '#8B0000',
                        'turk-blue': '#1D5D68', 
                        'turk-gold': '#C5A059',
                        'turk-sand': '#F4EBD9',
                        'turk-night': '#1A202C',
                    },
                    fontFamily: {
                        'serif': ['"Noto Serif TC"', 'serif'],
                        'display': ['"Cinzel"', 'serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* --- Styles --- */
        body {
            background-color: #F4EBD9;
            font-family: 'Noto Serif TC', serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; /* Space for bottom nav */
            overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
        }

        /* Ottoman Pattern Overlay */
        .pattern-bg {
            background-color: #F4EBD9;
            background-image: 
                radial-gradient(#C5A059 15%, transparent 16%),
                radial-gradient(#C5A059 15%, transparent 16%);
            background-size: 24px 24px;
            background-position: 0 0, 12px 12px;
            opacity: 0.15;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* Utility Classes */
        .card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #C5A059;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .marker-number {
            background-color: #8B0000;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Sortable Dragging Style */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #F3E5AB;
        }
        .sortable-drag {
            cursor: grabbing;
        }

        /* Map Container Height */
        #map {
            height: 35vh; /* Takes top 35% of screen */
            width: 100%;
            z-index: 0;
            border-bottom: 4px solid #C5A059;
        }

        /* Scrollable List Container */
        .scroll-container {
            height: 50vh;
            overflow-y: auto;
            padding-bottom: 80px;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body>

    <div class="pattern-bg"></div>

    <!-- Top Info Bar -->
    <div class="fixed top-0 w-full z-50 bg-turk-blue text-white shadow-lg px-4 py-2 flex justify-between items-center h-14">
        <div class="flex items-center space-x-2">
            <span class="text-turk-gold text-lg"><i class="fa-solid fa-moon"></i></span>
            <div class="leading-tight">
                <div class="text-[10px] opacity-70">ISTANBUL</div>
                <div id="clock-ist" class="font-bold text-sm font-mono">--:--</div>
            </div>
        </div>
        
        <div class="font-display text-turk-gold tracking-widest text-lg">ODYSSEY</div>

        <div class="flex items-center space-x-2 text-right">
            <div class="leading-tight">
                <div class="text-[10px] opacity-70">TAIPEI</div>
                <div id="clock-tpe" class="font-bold text-sm font-mono">--:--</div>
            </div>
            <span class="text-orange-300 text-lg"><i class="fa-solid fa-sun"></i></span>
        </div>
    </div>

    <!-- ================= VIEW 1: DASHBOARD (Rich Content) ================= -->
    <div id="view-dashboard" class="pt-16 px-4 pb-24 space-y-6 animate-fade-in">
        
        <!-- 1. Countdown -->
        <div class="bg-gradient-to-r from-turk-night to-turk-blue rounded-xl p-6 text-white text-center shadow-lg relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/arabesque.png')]"></div>
            <h2 class="text-turk-gold font-display text-xl mb-2">è·é›¢å‡ºç™¼é‚„æœ‰</h2>
            <div class="flex justify-center space-x-4 font-mono">
                <div><span id="days" class="text-3xl font-bold">--</span><div class="text-[10px]">DAYS</div></div>
                <div class="text-2xl opacity-50">:</div>
                <div><span id="hours" class="text-3xl font-bold">--</span><div class="text-[10px]">HRS</div></div>
            </div>
            <p class="text-xs mt-3 opacity-80"><i class="fa-solid fa-plane-departure mr-1"></i> 12/25 TPE -> BKK -> IST</p>
        </div>

        <!-- 2. Budget Tracker (Interactive) -->
        <div class="card p-4">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-turk-blue"><i class="fa-solid fa-wallet mr-2"></i>ä»Šæ—¥é ç®—æ§åˆ¶</h3>
                <button onclick="resetBudget()" class="text-xs text-gray-400 underline">é‡ç½®</button>
            </div>
            <div class="flex items-center space-x-2 mb-2">
                <div class="relative flex-1">
                    <span class="absolute left-3 top-2 text-gray-500">â‚º</span>
                    <input type="number" id="budget-input" placeholder="è¼¸å…¥æ¶ˆè²»" class="w-full pl-8 pr-3 py-2 border rounded-lg focus:ring-2 focus:ring-turk-gold outline-none">
                </div>
                <button onclick="addExpense()" class="bg-turk-gold text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-yellow-600 active:scale-95 transition">
                    è¨˜å¸³
                </button>
            </div>
            <div class="flex justify-between text-sm text-gray-600 bg-gray-50 p-2 rounded">
                <span>ä»Šæ—¥ç´¯ç©:</span>
                <span class="font-bold text-turk-red">â‚º <span id="total-spent">0</span></span>
            </div>
        </div>

        <!-- 3. Turkish Phrasebook (Scrollable) -->
        <div>
            <h3 class="font-display text-turk-dark mb-2 ml-1">ğŸ‡¹ğŸ‡· ç”Ÿå­˜åœŸè€³å…¶èª</h3>
            <div class="flex overflow-x-auto space-x-3 pb-2 scrollbar-hide">
                <div class="min-w-[140px] bg-white p-3 rounded-xl border-l-4 border-turk-blue shadow-sm">
                    <div class="text-xs text-gray-400">ä½ å¥½</div>
                    <div class="text-lg font-bold text-turk-dark">Merhaba</div>
                    <div class="text-xs text-gray-500 italic">æ¢…-å“ˆ-å§</div>
                </div>
                <div class="min-w-[140px] bg-white p-3 rounded-xl border-l-4 border-turk-red shadow-sm">
                    <div class="text-xs text-gray-400">è¬è¬</div>
                    <div class="text-lg font-bold text-turk-dark">TeÅŸekkÃ¼rler</div>
                    <div class="text-xs text-gray-500 italic">ç‰¹-è–›-åº«-å‹’</div>
                </div>
                <div class="min-w-[140px] bg-white p-3 rounded-xl border-l-4 border-turk-gold shadow-sm">
                    <div class="text-xs text-gray-400">å¤šå°‘éŒ¢?</div>
                    <div class="text-lg font-bold text-turk-dark">Ne kadar?</div>
                    <div class="text-xs text-gray-500 italic">å…§ å¡-é”?</div>
                </div>
                <div class="min-w-[140px] bg-white p-3 rounded-xl border-l-4 border-gray-600 shadow-sm">
                    <div class="text-xs text-gray-400">æ²’æœ‰ (æ‹’çµ•)</div>
                    <div class="text-lg font-bold text-turk-dark">Yok</div>
                    <div class="text-xs text-gray-500 italic">å„ª-å…‹</div>
                </div>
            </div>
        </div>

        <!-- 4. Checklist (Interactive) -->
        <div class="card p-4">
            <h3 class="font-bold text-turk-blue mb-3"><i class="fa-solid fa-clipboard-check mr-2"></i>è¡Œå‰ç¢ºèª</h3>
            <div class="space-y-2">
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-turk-blue rounded focus:ring-turk-gold">
                    <span class="text-sm text-gray-700">è­·ç…§èˆ‡é›»å­ç°½è­‰ (å°ç´™æœ¬å‚™ç”¨)</span>
                </label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-turk-blue rounded focus:ring-turk-gold">
                    <span class="text-sm text-gray-700">ç¾é‡‘/æ­å…ƒ (ç•¶åœ°æ›é‡Œæ‹‰)</span>
                </label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-turk-blue rounded focus:ring-turk-gold">
                    <span class="text-sm text-gray-700">ç‰™åˆ·/æ‹–é‹ (ç’°ä¿æ—…é¤¨å¸¸ä¸æä¾›)</span>
                </label>
                <label class="flex items-center space-x-3 p-2 bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" class="w-5 h-5 text-turk-blue rounded focus:ring-turk-gold">
                    <span class="text-sm text-gray-700">è½‰æ¥é ­ (æ­è¦é›™åœ“å­”)</span>
                </label>
            </div>
        </div>
    </div>

    <!-- ================= VIEW 2: MAP & PLANNER (Split View) ================= -->
    <div id="view-planner" class="hidden h-screen flex flex-col pt-14">
        
        <!-- Day Selector (Sticky) -->
        <div class="bg-turk-sand overflow-x-auto whitespace-nowrap p-2 shadow-inner z-10 flex space-x-2" id="day-selector">
            <!-- Populated by JS -->
        </div>

        <!-- Map Area (Top 35%) -->
        <div id="map"></div>

        <!-- Draggable List Area (Bottom 65% - Header height) -->
        <div class="flex-1 bg-white relative rounded-t-2xl -mt-4 z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex flex-col overflow-hidden">
            <div class="p-3 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-20">
                <div class="text-xs text-gray-500 flex items-center">
                    <i class="fa-solid fa-hand-pointer mr-1 animate-bounce"></i> é•·æŒ‰æ‹–æ›³å¯èª¿æ•´é †åº
                </div>
                <button onclick="openGoogleRoute()" class="bg-blue-600 text-white text-xs px-3 py-1.5 rounded-full shadow hover:bg-blue-700 flex items-center">
                    <i class="fa-solid fa-location-arrow mr-1"></i> Google å°èˆª
                </button>
            </div>
            
            <!-- List Container -->
            <div id="itinerary-list" class="flex-1 overflow-y-auto p-2 pb-24 space-y-2 bg-gray-50">
                <!-- Items populated by JS -->
            </div>
        </div>
    </div>

    <!-- ================= VIEW 3: GUIDE (Static) ================= -->
    <div id="view-guide" class="hidden pt-20 px-4 pb-24 space-y-6">
        <!-- Weather Card -->
        <div class="bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl p-6 text-white shadow-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="font-bold text-xl">12æœˆç©¿æ­å»ºè­°</h2>
                    <p class="text-sm opacity-90 mt-1">å‡æº« 8Â°C - 12Â°Cï¼Œå¤šé›¨æ¿•å†·ã€‚</p>
                </div>
                <i class="fa-solid fa-cloud-rain text-4xl opacity-80"></i>
            </div>
            <div class="mt-4 flex space-x-2 text-xs">
                <span class="bg-white/20 px-2 py-1 rounded">é˜²é¢¨å¤–å¥—</span>
                <span class="bg-white/20 px-2 py-1 rounded">åœå·¾</span>
                <span class="bg-white/20 px-2 py-1 rounded">é˜²æ°´é‹ (å¿…å‚™)</span>
            </div>
        </div>

        <!-- Scams -->
        <div class="card p-4 border-l-4 border-red-500">
            <h3 class="font-bold text-red-700 mb-2">ğŸš¨ å¸¸è¦‹é¨™å±€ (å¿…è®€)</h3>
            <ul class="list-disc pl-5 text-sm text-gray-700 space-y-2">
                <li><strong>æ“¦é‹åŒ :</strong> åˆ·å­æ‰åœ¨ä½ é¢å‰æ˜¯æ•…æ„çš„ï¼Œåƒè¬åˆ¥æ’¿ã€‚æ’¿äº†å°±è¦æ”¶ä½  50-100 é‡Œæ‹‰æ“¦é‹è²»ã€‚</li>
                <li><strong>å–ä¸€æ¯ (Let's have a drink):</strong> å–®èº«ç”·æ€§åœ¨ Taksim/Sultanahmet é‡åˆ°ç†±æƒ…è·¯äººé‚€ç´„å–é…’ï¼Œæœ€å¾Œå¸³å–®æœƒæ˜¯å¹¾è¬å°å¹£ã€‚</li>
                <li><strong>è¨ˆç¨‹è»Šæ›éˆ”:</strong> æ‹¿ 100 çµ¦å¸æ©Ÿï¼Œä»–æœƒåƒè®Šé­”è¡“ä¸€æ¨£æ›æˆ 20 èªªä½ çµ¦éŒ¯äº†ã€‚å»ºè­°ç”¨ Uber æˆ– BiTaksiã€‚</li>
            </ul>
        </div>
    </div>

    <!-- ================= BOTTOM NAV ================= -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-turk-gold/30 shadow-[0_-5px_10px_rgba(0,0,0,0.05)] h-20 z-50 safe-area-pb">
        <div class="grid grid-cols-3 h-full pb-2">
            <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center justify-center text-turk-dark" id="btn-dashboard">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-bold">é¦–é </span>
            </button>
            <button onclick="switchView('planner')" class="nav-item flex flex-col items-center justify-center text-gray-400" id="btn-planner">
                <div class="bg-turk-red text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg -mt-6 border-4 border-turk-sand">
                    <i class="fa-solid fa-map text-lg"></i>
                </div>
                <span class="text-[10px] font-bold mt-1">è¡Œç¨‹åœ°åœ–</span>
            </button>
            <button onclick="switchView('guide')" class="nav-item flex flex-col items-center justify-center text-gray-400" id="btn-guide">
                <i class="fa-solid fa-book-open text-xl mb-1"></i>
                <span class="text-[10px] font-bold">æ”»ç•¥</span>
            </button>
        </div>
    </nav>

    <!-- Currency Modal (Bottom Sheet) -->
    <button onclick="toggleCurrency()" class="fixed bottom-24 right-4 bg-turk-gold text-white p-3 rounded-full shadow-lg z-40 border-2 border-white">
        <i class="fa-solid fa-coins"></i>
    </button>

    <div id="currency-sheet" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="toggleCurrency()"></div>
        <div class="absolute bottom-0 w-full bg-white rounded-t-2xl p-6 shadow-2xl transition-transform transform translate-y-0">
            <h3 class="font-bold text-center text-lg mb-4 text-turk-dark">å¿«é€ŸåŒ¯ç‡ (TRY to TWD)</h3>
            <div class="flex items-center space-x-2 bg-gray-100 p-3 rounded-lg mb-4">
                <span class="text-xl">ğŸ‡¹ğŸ‡·</span>
                <input type="number" id="calc-try" value="100" class="w-full bg-transparent text-right text-2xl font-bold outline-none" oninput="calculateRate()">
                <span class="text-gray-500 font-bold">TRY</span>
            </div>
            <div class="flex justify-center text-turk-gold mb-4"><i class="fa-solid fa-arrow-down"></i></div>
            <div class="flex items-center space-x-2 bg-turk-sand/30 p-3 rounded-lg border border-turk-gold/30">
                <span class="text-xl">ğŸ‡¹ğŸ‡¼</span>
                <input type="text" id="calc-twd" readonly class="w-full bg-transparent text-right text-2xl font-bold text-turk-blue outline-none">
                <span class="text-gray-500 font-bold">TWD</span>
            </div>
            <p class="text-xs text-center mt-4 text-gray-400">åŒ¯ç‡ç´„ 0.93 (æµ®å‹•)</p>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        // --- 1. DATA: Geocoded Itinerary ---
        // Coordinates focused on grouping areas tightly
        const fullItinerary = [
            {
                date: "12/26",
                title: "æŠµé”èˆ‡åˆè¦‹",
                spots: [
                    { id: "s1", name: "ä¼Šæ–¯å¦å ¡æ©Ÿå ´ (IST)", lat: 41.261, lng: 28.742, icon: "fa-plane" },
                    { id: "s2", name: "JW Marriott Bosphorus", lat: 41.025, lng: 28.977, icon: "fa-hotel" },
                    { id: "s3", name: "KarakÃ¶y GÃ¼llÃ¼oÄŸlu (ç”œé»)", lat: 41.023, lng: 28.976, icon: "fa-utensils" }
                ]
            },
            {
                date: "12/27",
                title: "èˆŠåŸå€ç¶“å…¸",
                spots: [
                    { id: "s4", name: "JW Marriott (å‡ºç™¼)", lat: 41.025, lng: 28.977, icon: "fa-hotel" },
                    { id: "s5", name: "è–ç´¢è²äºå¤§æ¸…çœŸå¯º", lat: 41.0086, lng: 28.9802, icon: "fa-mosque" },
                    { id: "s6", name: "è—è‰²æ¸…çœŸå¯º", lat: 41.0054, lng: 28.9768, icon: "fa-mosque" },
                    { id: "s7", name: "Sultanahmet KÃ¶ftecisi (åˆé¤)", lat: 41.0075, lng: 28.9775, icon: "fa-utensils" },
                    { id: "s8", name: "åœ°ä¸‹æ°´å®®æ®¿", lat: 41.0084, lng: 28.9779, icon: "fa-water" }
                ]
            },
            {
                date: "12/28",
                title: "å¸‚é›†å¤§æ¡è³¼",
                spots: [
                    { id: "s9", name: "JW Marriott (é€€æˆ¿)", lat: 41.025, lng: 28.977, icon: "fa-suitcase" },
                    { id: "s10", name: "Orientbank Hotel (å¯„æ”¾è¡Œæ)", lat: 41.0163, lng: 28.9744, icon: "fa-hotel" },
                    { id: "s11", name: "å¤§å·´æ‰ (Grand Bazaar)", lat: 41.0107, lng: 28.9680, icon: "fa-bag-shopping" },
                    { id: "s12", name: "é¦™æ–™å¸‚å ´", lat: 41.0165, lng: 28.9705, icon: "fa-pepper-hot" },
                    { id: "s13", name: "Orientbank Hotel (å…¥ä½)", lat: 41.0163, lng: 28.9744, icon: "fa-bed" }
                ]
            },
            {
                date: "12/29",
                title: "å…¬ä¸»ç¾¤å³¶",
                spots: [
                    { id: "s14", name: "Kabatas ç¢¼é ­", lat: 41.0345, lng: 28.9934, icon: "fa-ship" },
                    { id: "s15", name: "Buyukada (å¤§å³¶)", lat: 40.8738, lng: 29.1276, icon: "fa-umbrella-beach" }
                ]
            },
            {
                date: "12/30",
                title: "æ–°åŸæ¼«æ­¥",
                spots: [
                    { id: "s16", name: "Taksim å»£å ´", lat: 41.0370, lng: 28.9850, icon: "fa-flag" },
                    { id: "s17", name: "ç¨ç«‹å¤§è¡—", lat: 41.0336, lng: 28.9780, icon: "fa-road" },
                    { id: "s18", name: "åŠ æ‹‰é”å¡”", lat: 41.0256, lng: 28.9741, icon: "fa-tower-observation" },
                    { id: "s19", name: "éŠèˆ¹ç¢¼é ­ (Eminonu)", lat: 41.018, lng: 28.973, icon: "fa-anchor" }
                ]
            },
            {
                date: "12/31",
                title: "äºæ´²å€è·¨å¹´",
                spots: [
                    { id: "s20", name: "Eminonu ç¢¼é ­", lat: 41.018, lng: 28.973, icon: "fa-ship" },
                    { id: "s21", name: "Kadikoy (äºæ´²å€)", lat: 40.990, lng: 29.025, icon: "fa-map-pin" },
                    { id: "s22", name: "Moda æµ·æ¿±", lat: 40.982, lng: 29.023, icon: "fa-water" },
                    { id: "s23", name: "Orientbank (è·¨å¹´æ™šé¤)", lat: 41.0163, lng: 28.9744, icon: "fa-champagne-glasses" }
                ]
            },
            {
                date: "01/01",
                title: "æ–°å¹´æ–‡é’éŠ",
                spots: [
                    { id: "s24", name: "è˜‡èŠæ›¼å°¼è€¶æ¸…çœŸå¯º", lat: 41.0162, lng: 28.9638, icon: "fa-mosque" },
                    { id: "s25", name: "Balat å½©è‰²è¡—å€", lat: 41.0315, lng: 28.9472, icon: "fa-camera" },
                    { id: "s26", name: "Pierre Loti å±±ä¸˜", lat: 41.0543, lng: 28.9340, icon: "fa-mountain-sun" },
                    { id: "s27", name: "å‰å¾€æ©Ÿå ´ (IST)", lat: 41.261, lng: 28.742, icon: "fa-plane-departure" }
                ]
            }
        ];

        // State Management
        let currentDayIndex = 0;
        let map = null;
        let markers = [];
        let polyline = null;
        let sortable = null;

        // --- 2. MAP & LIST LOGIC ---

        function initMap() {
            if(map) return;
            // Initialize Leaflet
            map = L.map('map', {zoomControl: false}).setView([41.0082, 28.9784], 13);
            
            // Minimalist Tile Layer (CartoDB Light)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'Â©OpenStreetMap, Â©CartoDB',
                maxZoom: 19
            }).addTo(map);

            renderDaySelector();
            loadDay(0); // Load first day
        }

        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = fullItinerary.map((day, idx) => `
                <button onclick="loadDay(${idx})" 
                    class="day-btn px-4 py-2 rounded-full text-xs font-bold transition flex-shrink-0 ${idx === 0 ? 'bg-turk-blue text-white shadow' : 'bg-white text-gray-500 border border-gray-200'}" 
                    data-idx="${idx}">
                    ${day.date}
                </button>
            `).join('');
        }

        function loadDay(idx) {
            currentDayIndex = idx;
            const data = fullItinerary[idx];

            // Update Buttons
            document.querySelectorAll('.day-btn').forEach(btn => {
                if(parseInt(btn.dataset.idx) === idx) {
                    btn.className = 'day-btn px-4 py-2 rounded-full text-xs font-bold transition flex-shrink-0 bg-turk-blue text-white shadow';
                } else {
                    btn.className = 'day-btn px-4 py-2 rounded-full text-xs font-bold transition flex-shrink-0 bg-white text-gray-500 border border-gray-200';
                }
            });

            // Update Map
            updateMap(data.spots);

            // Update List
            renderList(data.spots);
        }

        function updateMap(spots) {
            // Clear existing
            markers.forEach(m => map.removeLayer(m));
            if(polyline) map.removeLayer(polyline);
            markers = [];

            const latlngs = [];

            spots.forEach((spot, i) => {
                // Custom Numbered Icon
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class='marker-number'>${i+1}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker([spot.lat, spot.lng], {icon: icon})
                    .addTo(map)
                    .bindPopup(`<b>${spot.name}</b>`);
                
                markers.push(marker);
                latlngs.push([spot.lat, spot.lng]);
            });

            // Draw connecting line
            if(latlngs.length > 0) {
                polyline = L.polyline(latlngs, {color: '#1D5D68', weight: 4, opacity: 0.7, dashArray: '5, 10'}).addTo(map);
                // Fit bounds to show all points
                map.fitBounds(polyline.getBounds(), {padding: [50, 50]});
            }
        }

        function renderList(spots) {
            const listContainer = document.getElementById('itinerary-list');
            listContainer.innerHTML = '';

            spots.forEach((spot, i) => {
                const el = document.createElement('div');
                el.className = 'bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between group cursor-grab active:cursor-grabbing';
                el.dataset.id = spot.id;
                el.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="w-6 h-6 bg-turk-red text-white rounded-full flex items-center justify-center text-xs font-bold handle">
                            ${i + 1}
                        </div>
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${spot.name}</div>
                            <div class="text-xs text-gray-400"><i class="fa-solid ${spot.icon}"></i> é»æ“Šå°èˆª</div>
                        </div>
                    </div>
                    <div class="text-gray-300">
                        <i class="fa-solid fa-bars"></i>
                    </div>
                `;
                // Click on text to pan map
                el.querySelector('div.font-bold').addEventListener('click', () => {
                   map.flyTo([spot.lat, spot.lng], 16);
                   markers[i].openPopup();
                });
                listContainer.appendChild(el);
            });

            // Init Sortable
            if(sortable) sortable.destroy();
            sortable = new Sortable(listContainer, {
                animation: 150,
                handle: '.bg-white', // Drag whole item
                onEnd: function (evt) {
                    // Reorder Data
                    const item = fullItinerary[currentDayIndex].spots.splice(evt.oldIndex, 1)[0];
                    fullItinerary[currentDayIndex].spots.splice(evt.newIndex, 0, item);
                    
                    // Refresh Map & List Indices
                    updateMap(fullItinerary[currentDayIndex].spots);
                    renderList(fullItinerary[currentDayIndex].spots);
                }
            });
        }

        // --- 3. GOOGLE MAPS NAVIGATION (Route) ---
        function openGoogleRoute() {
            const spots = fullItinerary[currentDayIndex].spots;
            if (spots.length < 2) {
                alert("è‡³å°‘éœ€è¦å…©å€‹åœ°é»æ‰èƒ½å°èˆª");
                return;
            }

            // Google Maps URL Format:
            // https://www.google.com/maps/dir/?api=1&origin=Lat,Lng&destination=Lat,Lng&waypoints=Lat,Lng|Lat,Lng&travelmode=walking
            
            // We use the first spot as origin (assuming user starts there, or we can leave origin blank to use current location)
            // Strategy: Let's use the first spot as 'destination' relative to user, OR build a full route.
            // Best for planning: Full route from Spot 1 to End.
            
            const origin = `${spots[0].lat},${spots[0].lng}`;
            const destination = `${spots[spots.length-1].lat},${spots[spots.length-1].lng}`;
            
            let waypoints = "";
            if (spots.length > 2) {
                const intermediate = spots.slice(1, spots.length - 1);
                waypoints = "&waypoints=" + intermediate.map(s => `${s.lat},${s.lng}`).join('|');
            }

            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}&travelmode=walking`;
            window.open(url, '_blank');
        }


        // --- 4. DASHBOARD UTILS ---
        function calculateRate() {
            const rate = 0.93; 
            const val = document.getElementById('calc-try').value;
            document.getElementById('calc-twd').value = (val * rate).toFixed(1);
        }
        function toggleCurrency() {
            document.getElementById('currency-sheet').classList.toggle('hidden');
        }

        // Budget
        let totalSpent = 0;
        function addExpense() {
            const val = parseFloat(document.getElementById('budget-input').value);
            if(val) {
                totalSpent += val;
                document.getElementById('total-spent').innerText = totalSpent;
                document.getElementById('budget-input').value = '';
            }
        }
        function resetBudget() {
            totalSpent = 0;
            document.getElementById('total-spent').innerText = 0;
        }

        // Countdown
        function updateCountdown() {
            const target = new Date('2025-12-25T09:25:00').getTime();
            const now = new Date().getTime();
            const diff = target - now;

            if(diff > 0) {
                document.getElementById('days').innerText = Math.floor(diff / (1000 * 60 * 60 * 24));
                document.getElementById('hours').innerText = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            } else {
                document.getElementById('days').innerText = "0";
            }
        }

        // Clocks
        function updateClocks() {
            const now = new Date();
            const ist = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Istanbul"}));
            const tpe = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
            document.getElementById('clock-ist').innerText = ist.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false});
            document.getElementById('clock-tpe').innerText = tpe.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false});
        }

        // View Switcher
        function switchView(viewId) {
            // Hide all
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-guide').classList.add('hidden');
            
            // Show one
            document.getElementById('view-' + viewId).classList.remove('hidden');

            // Reset Nav
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('text-turk-dark', 'active');
                el.classList.add('text-gray-400');
            });
            document.getElementById('btn-' + viewId).classList.add('text-turk-dark', 'active');
            document.getElementById('btn-' + viewId).classList.remove('text-gray-400');

            // Map resize fix
            if(viewId === 'planner') {
                setTimeout(() => {
                    initMap();
                    map.invalidateSize();
                }, 100);
            }
            window.scrollTo(0,0);
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            updateClocks();
            setInterval(updateClocks, 1000);
            updateCountdown();
            calculateRate();
        });
    </script>
</body>
</html>
