<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼Šæ–¯å¦å ¡å…¨èƒ½å°éŠ (KML+åœ°åœ–ç‰ˆ)</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'turk-red': '#8B0000',
                        'turk-blue': '#1D5D68', 
                        'turk-gold': '#C5A059',
                        'turk-sand': '#F4EBD9',
                        'turk-night': '#1A202C',
                    },
                    fontFamily: {
                        'serif': ['"Noto Serif TC"', 'serif'],
                        'display': ['"Cinzel"', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F4EBD9;
            font-family: 'Noto Serif TC', serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            overscroll-behavior-y: none;
        }

        .pattern-bg {
            background-image: 
                radial-gradient(#C5A059 15%, transparent 16%),
                radial-gradient(#C5A059 15%, transparent 16%);
            background-size: 24px 24px;
            background-position: 0 0, 12px 12px;
            opacity: 0.15;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* Marker Styles */
        .marker-number {
            background-color: #8B0000;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            border: 2px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
        }

        .marker-backup {
            background-color: #6B7280;
            opacity: 0.8;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .marker-temp {
            background-color: #C5A059;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px #C5A059;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Popup Styling */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 200px !important;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #C5A059;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .sortable-ghost { opacity: 0.4; background-color: #F3E5AB; }
        #map { height: 50vh; width: 100%; z-index: 0; border-bottom: 4px solid #C5A059; }
    </style>
</head>
<body>

    <div class="pattern-bg"></div>

    <!-- Top Bar -->
    <div class="fixed top-0 w-full z-50 bg-turk-blue text-white shadow-lg px-4 py-2 flex justify-between items-center h-14">
        <div class="flex flex-col">
            <div class="flex items-center space-x-1 text-turk-gold">
                <i class="fa-solid fa-moon text-xs"></i>
                <span class="text-[10px] opacity-80">ISTANBUL</span>
            </div>
            <div id="clock-ist" class="font-bold text-sm font-mono leading-none">--:--</div>
        </div>
        <div class="font-display text-turk-gold text-lg tracking-widest">ODYSSEY</div>
        <div class="flex flex-col text-right">
            <div class="flex items-center justify-end space-x-1 text-orange-300">
                <span class="text-[10px] opacity-80">TAIPEI</span>
                <i class="fa-solid fa-sun text-xs"></i>
            </div>
            <div id="clock-tpe" class="font-bold text-sm font-mono leading-none">--:--</div>
        </div>
    </div>

    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="pt-16 px-4 pb-24 space-y-5 animate-fade-in">
        
        <!-- Main Actions -->
        <div class="bg-gradient-to-r from-turk-night to-turk-blue rounded-xl p-5 text-white text-center shadow-lg relative overflow-hidden">
            <h2 class="text-turk-gold font-display text-lg mb-1">è·é›¢å‡ºç™¼</h2>
            <div class="flex justify-center items-baseline space-x-2 font-mono">
                <span id="days" class="text-4xl font-bold">--</span><span class="text-xs">DAYS</span>
            </div>
            <button onclick="switchView('planner')" class="mt-3 bg-turk-gold text-white px-6 py-2 rounded-full text-sm font-bold shadow hover:bg-yellow-600 transition">
                é€²å…¥è¡Œç¨‹åœ°åœ–
            </button>
        </div>

        <!-- Sync Actions -->
        <div class="card p-4">
            <h3 class="font-bold text-turk-blue mb-3 text-sm flex items-center justify-between">
                <span><i class="fa-solid fa-share-nodes mr-2"></i>è³‡æ–™èˆ‡å‚™ä»½</span>
                <span class="text-[10px] bg-green-100 text-green-700 px-2 rounded-full" id="save-status">å·²è‡ªå‹•å„²å­˜</span>
            </h3>
            
            <!-- KML IMPORT BUTTON -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-3">
                <h4 class="text-xs font-bold text-gray-600 mb-2 flex items-center">
                    <i class="fa-solid fa-map text-turk-blue mr-1"></i> åŒ¯å…¥ KML åœ–è³‡
                </h4>
                <p class="text-[10px] text-gray-500 mb-2 leading-relaxed">
                    å°‡ Google My Maps åŒ¯å‡ºçš„ KML æª”æ¡ˆåŒ¯å…¥ç‚ºå‚™ç”¨æ™¯é»ã€‚
                </p>
                <input type="file" id="kml-input" accept=".kml,.xml" class="hidden" onchange="handleKMLUpload(this)">
                <button onclick="document.getElementById('kml-input').click()" class="w-full bg-white border border-turk-gold text-turk-gold py-2 rounded-lg text-xs font-bold hover:bg-turk-sand transition flex items-center justify-center">
                    <i class="fa-solid fa-file-import mr-2"></i> é¸æ“‡æª”æ¡ˆ (.kml)
                </button>
            </div>

            <div class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-200">
                <button onclick="exportData()" class="text-turk-blue text-xs font-bold hover:underline text-left">
                    <i class="fa-solid fa-copy mr-1"></i> è¤‡è£½è¡Œç¨‹ä»£ç¢¼
                </button>
                <button onclick="importDataModal()" class="text-gray-600 text-xs font-bold hover:underline text-right">
                    <i class="fa-solid fa-paste mr-1"></i> è²¼ä¸Šè¡Œç¨‹ä»£ç¢¼
                </button>
            </div>
            <div class="mt-3 text-[10px] text-gray-400 text-center">
                <button onclick="resetToDefault()" class="underline hover:text-red-500">é‡ç½®ç‚ºåŸå§‹è¨­å®š</button>
            </div>
        </div>

        <!-- Budget -->
        <div class="card p-4">
            <div class="flex justify-between items-center mb-3">
                <h3 class="font-bold text-turk-blue text-sm"><i class="fa-solid fa-wallet mr-2"></i>ä»Šæ—¥è¨˜å¸³</h3>
                <button onclick="resetBudget()" class="text-xs text-gray-400">é‡ç½®</button>
            </div>
            <div class="flex items-center space-x-2 mb-2">
                <input type="number" id="budget-input" placeholder="é‡‘é¡ (TRY)" class="w-full pl-3 py-2 border rounded-lg outline-none text-sm">
                <button onclick="addExpense()" class="bg-turk-gold text-white px-4 py-2 rounded-lg font-bold shadow text-sm whitespace-nowrap"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div class="flex justify-between text-sm bg-gray-50 p-2 rounded">
                <span class="text-gray-500">ç´¯ç©:</span>
                <span class="font-bold text-turk-red">â‚º <span id="total-spent">0</span></span>
            </div>
        </div>
    </div>

    <!-- PLANNER VIEW -->
    <div id="view-planner" class="hidden h-screen flex flex-col pt-14">
        <div class="bg-turk-sand overflow-x-auto whitespace-nowrap p-2 shadow-inner z-10 flex space-x-2" id="day-selector"></div>
        <div class="relative">
            <div id="map"></div>
            <!-- Map Controls -->
            <div class="absolute top-3 right-3 z-[400] flex flex-col gap-2">
                <button onclick="toggleAddMode()" id="add-mode-btn" class="bg-white text-turk-dark p-2 rounded-lg shadow-lg border border-gray-200 text-xs font-bold w-10 h-10 flex items-center justify-center">
                    <i class="fa-solid fa-search"></i>
                </button>
            </div>
            <div id="add-hint" class="absolute top-3 left-1/2 transform -translate-x-1/2 z-[400] bg-turk-gold text-white text-xs px-4 py-2 rounded-full shadow-lg hidden whitespace-nowrap">
                é»æ“Šåœ°åœ–ä½ç½®
            </div>
        </div>
        <div class="flex-1 bg-white relative rounded-t-2xl -mt-4 z-10 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] flex flex-col overflow-hidden">
            <div class="p-3 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-20">
                <div class="text-xs text-gray-500"><i class="fa-solid fa-route mr-1 text-turk-blue"></i> æ‹–æ›³èª¿æ•´é †åº</div>
                <button onclick="openGoogleRoute()" class="bg-blue-600 text-white text-xs px-3 py-1.5 rounded-full shadow flex items-center"><i class="fa-solid fa-diamond-turn-right mr-1"></i> Google å°èˆª</button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 pb-24 p-2 space-y-4">
                <div>
                    <!-- Active Itinerary Only -->
                    <div id="itinerary-list" class="space-y-2 min-h-[100px]"></div>
                    <div class="mt-8 text-center text-xs text-gray-400 p-4 border-t border-gray-200 border-dashed">
                        <p><i class="fa-solid fa-circle-info mr-1"></i> æ“ä½œæç¤º</p>
                        <p class="mt-1">é»æ“Šåœ°åœ–ä¸Šçš„ç°è‰²åœ“é»å¯åŠ å…¥è¡Œç¨‹</p>
                        <p class="mt-1">é»æ“Šç´…è‰²åœ“é»å¯ç§»å›å‚™ç”¨æ¸…å–®</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- GUIDE VIEW -->
    <div id="view-guide" class="hidden pt-20 px-4 pb-24 space-y-6">
        <div class="card p-4 border-l-4 border-red-500">
            <h3 class="font-bold text-red-800 mb-2 text-sm"><i class="fa-solid fa-triangle-exclamation mr-2"></i>é˜²é¨™</h3>
            <ul class="text-xs text-gray-700 space-y-2 list-disc pl-4">
                <li>æ“¦é‹åŒ æ‰åˆ·å­åˆ¥æ’¿ã€‚</li>
                <li>ç¨è¡Œç”·æ€§å‹¿éš¨äººå»é…’å§ã€‚</li>
                <li>è¨ˆç¨‹è»Šå …æŒè·³éŒ¶ã€‚</li>
            </ul>
        </div>
        <div class="card p-4 border-l-4 border-turk-blue">
            <h3 class="font-bold text-turk-blue mb-2 text-sm">ç·Šæ€¥è¯çµ¡</h3>
            <p class="text-xs text-gray-700">è­¦å¯Ÿ: 155 | æ€¥æ•‘: 112</p>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-turk-gold/30 shadow-lg h-20 z-50">
        <div class="grid grid-cols-3 h-full pb-2">
            <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center justify-center text-turk-dark" id="btn-dashboard"><i class="fa-solid fa-house text-xl mb-1"></i><span class="text-[10px] font-bold">é¦–é </span></button>
            <button onclick="switchView('planner')" class="nav-item flex flex-col items-center justify-center text-gray-400" id="btn-planner"><div class="bg-turk-red text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg -mt-6 border-4 border-turk-sand"><i class="fa-solid fa-map text-lg"></i></div><span class="text-[10px] font-bold mt-1">åœ°åœ–</span></button>
            <button onclick="switchView('guide')" class="nav-item flex flex-col items-center justify-center text-gray-400" id="btn-guide"><i class="fa-solid fa-book-open text-xl mb-1"></i><span class="text-[10px] font-bold">æ”»ç•¥</span></button>
        </div>
    </nav>

    <!-- Floating Currency -->
    <button onclick="toggleCurrency()" class="fixed bottom-24 right-4 bg-turk-gold text-white w-12 h-12 rounded-full shadow-lg z-40 border-2 border-white flex items-center justify-center active:scale-90 transition"><i class="fa-solid fa-coins"></i></button>

    <!-- MODALS -->
    <!-- Currency -->
    <div id="currency-sheet" class="fixed inset-0 z-[100] hidden flex items-end sm:items-center sm:justify-center pointer-events-none">
        <div class="absolute inset-0 bg-black/50 pointer-events-auto transition-opacity" onclick="toggleCurrency()"></div>
        <div class="bg-white w-full sm:w-80 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl relative pointer-events-auto">
            <h3 class="font-bold text-center text-turk-dark mb-4">åŒ¯ç‡æ›ç®— (TRY â†’ TWD)</h3>
            <div class="flex items-center gap-2 bg-gray-100 p-3 rounded-lg mb-2"><span class="text-xl">ğŸ‡¹ğŸ‡·</span><input type="number" id="calc-try" value="100" class="w-full bg-transparent text-right text-2xl font-bold outline-none" oninput="calculateRate()"><span class="text-xs font-bold text-gray-500">TRY</span></div>
            <div class="text-center text-turk-gold text-sm my-1"><i class="fa-solid fa-arrow-down"></i></div>
            <div class="flex items-center gap-2 bg-turk-sand/30 p-3 rounded-lg border border-turk-gold/30"><span class="text-xl">ğŸ‡¹ğŸ‡¼</span><input type="text" id="calc-twd" readonly class="w-full bg-transparent text-right text-2xl font-bold text-turk-blue outline-none"><span class="text-xs font-bold text-gray-500">TWD</span></div>
            <p class="text-xs text-center mt-4 text-gray-400">åŒ¯ç‡ç´„ 0.93 (æµ®å‹•)</p>
        </div>
    </div>

    <!-- Add Spot -->
    <div id="name-modal" class="fixed inset-0 z-[1000] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white p-5 rounded-xl shadow-2xl w-80">
            <h3 class="font-bold text-turk-dark mb-3 text-lg border-b pb-2">æ–°å¢æ™¯é»</h3>
            <div class="mb-4">
                <label class="text-xs text-gray-500 mb-1 block">1. æœå°‹ (OpenStreetMap)</label>
                <div class="flex space-x-2 relative">
                    <input type="text" id="search-query" placeholder="è¼¸å…¥åç¨± (å¦‚: Galata Tower)" class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-turk-blue outline-none bg-gray-50">
                    <button onclick="searchPlace()" class="bg-turk-blue text-white px-3 rounded text-sm whitespace-nowrap"><i class="fa-solid fa-search"></i></button>
                </div>
                <ul id="search-results" class="hidden mt-2 bg-white border rounded shadow-md max-h-32 overflow-y-auto text-xs divide-y"></ul>
            </div>
            <div class="mb-4">
                <label class="text-xs text-gray-500 mb-1 block">2. ç¢ºèªåç¨±</label>
                <input type="text" id="new-spot-name" placeholder="æ™¯é»åç¨±..." class="w-full border p-2 rounded text-sm focus:ring-2 focus:ring-turk-gold outline-none font-bold text-turk-dark">
                <p id="location-status" class="text-[10px] text-gray-400 mt-1 italic"><i class="fa-solid fa-location-dot"></i> è«‹å…ˆæœå°‹æˆ–é»æ“Šåœ°åœ–é¸æ“‡ä½ç½®</p>
            </div>
            <div class="flex justify-end gap-2 border-t pt-3">
                <button onclick="cancelAddSpot()" class="px-4 py-2 text-gray-500 text-sm hover:bg-gray-100 rounded">å–æ¶ˆ</button>
                <button onclick="confirmAddSpot()" class="px-4 py-2 bg-turk-gold text-white rounded text-sm font-bold shadow hover:bg-yellow-600">åŠ å…¥å‚™ç”¨</button>
            </div>
        </div>
    </div>

    <!-- Sync -->
    <div id="sync-modal" class="fixed inset-0 z-[2000] hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-[90%] max-w-sm">
            <h3 class="font-bold text-lg text-turk-dark mb-2" id="sync-title">åˆ†äº«è¡Œç¨‹</h3>
            <p class="text-xs text-gray-500 mb-4" id="sync-desc">è¤‡è£½ä¸‹æ–¹ä»£ç¢¼å‚³çµ¦æœ‹å‹ï¼Œæˆ–è²¼ä¸Šæœ‹å‹çš„ä»£ç¢¼ã€‚</p>
            <textarea id="sync-data" class="w-full h-32 border border-gray-300 rounded p-2 text-xs font-mono bg-gray-50 focus:ring-2 focus:ring-turk-blue outline-none break-all" readonly></textarea>
            <div class="mt-4 flex flex-col gap-2" id="sync-actions"></div>
            <button onclick="document.getElementById('sync-modal').classList.add('hidden')" class="mt-4 w-full text-gray-500 text-xs py-2">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const defaultItinerary = [
            { date: "12/26", spots: [ { id: "s1", name: "ä¼Šæ–¯å¦å ¡æ©Ÿå ´", lat: 41.261, lng: 28.742, icon: "fa-plane" }, { id: "s2", name: "JW Marriott (å…¥ä½)", lat: 41.025, lng: 28.977, icon: "fa-hotel" } ] },
            { date: "12/27", spots: [ { id: "s5", name: "è–ç´¢è²äºæ¸…çœŸå¯º", lat: 41.0086, lng: 28.9802, icon: "fa-mosque" }, { id: "s6", name: "è—è‰²æ¸…çœŸå¯º", lat: 41.0054, lng: 28.9768, icon: "fa-mosque" }, { id: "s8", name: "åœ°ä¸‹æ°´å®®æ®¿", lat: 41.0084, lng: 28.9779, icon: "fa-water" } ] },
            { date: "12/28", spots: [ { id: "s11", name: "å¤§å·´æ‰", lat: 41.0107, lng: 28.9680, icon: "fa-bag-shopping" }, { id: "s12", name: "é¦™æ–™å¸‚å ´", lat: 41.0165, lng: 28.9705, icon: "fa-pepper-hot" }, { id: "s13", name: "Orientbank (æ›é£¯åº—)", lat: 41.0163, lng: 28.9744, icon: "fa-hotel" } ] },
            { date: "12/29", spots: [ { id: "s14", name: "Kabatas ç¢¼é ­", lat: 41.0345, lng: 28.9934, icon: "fa-ship" }, { id: "s15", name: "å…¬ä¸»ç¾¤å³¶ (å¤§å³¶)", lat: 40.8738, lng: 29.1276, icon: "fa-umbrella-beach" } ] },
            { date: "12/30", spots: [ { id: "s16", name: "ç¨ç«‹å¤§è¡—", lat: 41.0336, lng: 28.9780, icon: "fa-road" }, { id: "s18", name: "åŠ æ‹‰é”å¡”", lat: 41.0256, lng: 28.9741, icon: "fa-tower-observation" } ] },
            { date: "12/31", spots: [ { id: "s21", name: "Kadikoy (äºæ´²å€)", lat: 40.990, lng: 29.025, icon: "fa-map-pin" }, { id: "s23", name: "è·¨å¹´æ™šé¤", lat: 41.0163, lng: 28.9744, icon: "fa-champagne-glasses" } ] },
            { date: "01/01", spots: [ { id: "s24", name: "è˜‡èŠæ›¼å°¼è€¶æ¸…çœŸå¯º", lat: 41.0162, lng: 28.9638, icon: "fa-mosque" }, { id: "s25", name: "Balat å½©è‰²è¡—å€", lat: 41.0315, lng: 28.9472, icon: "fa-camera" } ] }
        ];

        // Default KML/Backup List
        const defaultBackup = [
            { id: "k1", name: "Pierre Loti Hill", lat: 41.0542212, lng: 28.9337884, icon: "fa-mountain" },
            { id: "k2", name: "Ã‡amlÄ±ca Tower", lat: 41.0163191, lng: 29.0655582, icon: "fa-tower-broadcast" },
            { id: "k3", name: "æ‰˜æ™®å¡åŒ¹çš‡å®®", lat: 41.0115195, lng: 28.9833789, icon: "fa-landmark" },
            { id: "k4", name: "AhÅŸap Evler", lat: 41.0338085, lng: 29.03165, icon: "fa-house" },
            { id: "k5", name: "Beylerbeyi Palace", lat: 41.0426451, lng: 29.039905, icon: "fa-landmark" },
            { id: "k6", name: "Miniaturk", lat: 41.0589927, lng: 28.9492193, icon: "fa-magnifying-glass" },
            { id: "k7", name: "Kuzguncuk BostanÄ±", lat: 41.0346407, lng: 29.03147, icon: "fa-seedling" },
            { id: "k8", name: "Istanbul Lamps Workshops", lat: 41.0095807, lng: 28.9679256, icon: "fa-lightbulb" },
            { id: "k9", name: "KÃ¼Ã§Ã¼ksu Pavilion", lat: 41.0784181, lng: 29.0648789, icon: "fa-place-of-worship" },
            { id: "k10", name: "KÃ¼Ã§Ã¼kÃ‡iftlik Park", lat: 41.042965, lng: 28.99297, icon: "fa-tree" },
            { id: "k11", name: "è˜‡èŠæ›¼å°¼è€¶æ¸…çœŸå¯º", lat: 41.016047, lng: 28.9639711, icon: "fa-mosque" },
            { id: "k12", name: "Agios Panteleimonas Church", lat: 41.0346085, lng: 29.0305442, icon: "fa-church" },
            { id: "k13", name: "Florence Nightingale Museum", lat: 41.0069533, lng: 29.0167853, icon: "fa-kit-medical" },
            { id: "k14", name: "Galataport Istanbul", lat: 41.0276477, lng: 28.9852806, icon: "fa-ship" },
            { id: "k15", name: "Camlica Hill", lat: 41.028244, lng: 29.0691617, icon: "fa-mountain" },
            { id: "k16", name: "BÃ¼yÃ¼k Valide Han", lat: 41.0130856, lng: 28.9683738, icon: "fa-archway" },
            { id: "k17", name: "å°‘å¥³å¡”", lat: 41.0211216, lng: 29.0041105, icon: "fa-tower-observation" },
            { id: "k18", name: "Bosphorus View Point", lat: 41.03375, lng: 29.029934, icon: "fa-camera" },
            { id: "k19", name: "Camlica Terrace", lat: 41.0351833, lng: 29.0691303, icon: "fa-mug-hot" },
            { id: "k20", name: "Kuzguncuk Evleri", lat: 41.0356182, lng: 29.0300243, icon: "fa-house-chimney" },
            { id: "k21", name: "é¦™æ–™å¸‚é›†", lat: 41.016499, lng: 28.9705191, icon: "fa-pepper-hot" },
            { id: "k22", name: "Ä°stiklal Caddesi", lat: 41.0322178, lng: 28.9762806, icon: "fa-road" },
            { id: "k23", name: "è–å–¬æ²»ä¸»æ•™åº§å ‚", lat: 41.0292218, lng: 28.9517316, icon: "fa-church" },
            { id: "k24", name: "ç§‘æ‹‰æ•™å ‚", lat: 41.031205, lng: 28.9391883, icon: "fa-church" },
            { id: "k25", name: "Orientbank Hotel", lat: 41.0151366, lng: 28.9723512, icon: "fa-hotel" },
            { id: "k26", name: "ÃœskÃ¼dar Tekel Stage", lat: 41.031436, lng: 29.0216139, icon: "fa-masks-theater" },
            { id: "k27", name: "Neviye SokaÄŸÄ± Merdivenleri", lat: 41.0051835, lng: 28.9678151, icon: "fa-stairs" },
            { id: "k28", name: "å¡”å…‹è¥¿å§†å»£å ´", lat: 41.0370023, lng: 28.9850917, icon: "fa-flag" },
            { id: "k29", name: "ä½ç›§ä¸­å¿ƒ (Zorlu)", lat: 41.0669934, lng: 29.0155549, icon: "fa-bag-shopping" },
            { id: "k30", name: "æ–°çš‡å¤ªåæ¸…çœŸå¯º", lat: 41.0247332, lng: 29.0150879, icon: "fa-mosque" },
            { id: "k31", name: "ç±³èµ«é‡Œé¦¬èµ«è˜‡ä¸¹æ¸…çœŸå¯º", lat: 41.0267792, lng: 29.0159815, icon: "fa-mosque" },
            { id: "k32", name: "Ã‡iÃ§ek PasajÄ±", lat: 41.0339387, lng: 28.9780878, icon: "fa-utensils" },
            { id: "k33", name: "è˜‡ä¸¹è‰¾å“ˆé‚å¾·æ¸…çœŸå¯º", lat: 41.0054096, lng: 28.9768138, icon: "fa-mosque" },
            { id: "k34", name: "EyÃ¼p Sultan Mosque", lat: 41.0479225, lng: 28.9338509, icon: "fa-mosque" },
            { id: "k35", name: "JW Marriott Bosphorus", lat: 41.0241112, lng: 28.9792252, icon: "fa-hotel" },
            { id: "k36", name: "å¥§å¡”ç§‘ä¼Šæ¸…çœŸå¯º", lat: 41.0472151, lng: 29.0269478, icon: "fa-mosque" }
        ];

        // State variables
        let itineraryData = JSON.parse(JSON.stringify(defaultItinerary));
        let backupSpots = JSON.parse(JSON.stringify(defaultBackup));

        let currentDayIndex = 0;
        let map = null, polyline = null;
        let activeMarkers = [], backupMarkers = [];
        let activeSortable = null;
        let isAddMode = false, tempLatLng = null, tempMarker = null;

        // --- GLOBAL ACTIONS ---
        window.addToItinerary = function(id) {
            const spotIndex = backupSpots.findIndex(s => s.id === id);
            if(spotIndex > -1) {
                const spot = backupSpots[spotIndex];
                backupSpots.splice(spotIndex, 1);
                itineraryData[currentDayIndex].spots.push(spot);
                saveState();
                updateAll();
            }
        };

        window.removeFromItinerary = function(id) {
            const spotIndex = itineraryData[currentDayIndex].spots.findIndex(s => s.id === id);
            if(spotIndex > -1) {
                const spot = itineraryData[currentDayIndex].spots[spotIndex];
                itineraryData[currentDayIndex].spots.splice(spotIndex, 1);
                backupSpots.push(spot);
                saveState();
                updateAll();
            }
        };

        // --- KML UPLOAD ---
        function handleKMLUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(text, "text/xml");
                const placemarks = xmlDoc.getElementsByTagName("Placemark");
                let count = 0;
                for (let i = 0; i < placemarks.length; i++) {
                    const name = placemarks[i].getElementsByTagName("name")[0]?.textContent || "æœªå‘½å";
                    const pointStr = placemarks[i].getElementsByTagName("coordinates")[0]?.textContent;
                    if (pointStr) {
                        const coords = pointStr.trim().split(',');
                        const lng = parseFloat(coords[0]);
                        const lat = parseFloat(coords[1]);
                        if(!isNaN(lat) && !isNaN(lng)) {
                            // Check dupes
                            if(!backupSpots.some(s => s.name === name) && !itineraryData.some(d => d.spots.some(s => s.name === name))) {
                                backupSpots.push({
                                    id: 'kml_' + Date.now() + '_' + i,
                                    name: name,
                                    lat: lat,
                                    lng: lng,
                                    icon: 'fa-map-pin'
                                });
                                count++;
                            }
                        }
                    }
                }
                if(count > 0) {
                    saveState();
                    updateAll();
                    alert(`æˆåŠŸåŒ¯å…¥ ${count} å€‹æ–°æ™¯é»ï¼`);
                } else {
                    alert("åŒ¯å…¥å®Œæˆï¼Œä½†æ²’æœ‰ç™¼ç¾æ–°æ™¯é» (å¯èƒ½é‡è¤‡æˆ–æ ¼å¼éŒ¯èª¤)ã€‚");
                }
            };
            reader.readAsText(file);
        }

        // --- LOCAL STORAGE ---
        function saveState() {
            const state = { itinerary: itineraryData, backup: backupSpots };
            localStorage.setItem('turk_planner_data', JSON.stringify(state));
            const status = document.getElementById('save-status');
            status.innerText = "å·²å„²å­˜";
            status.className = "text-[10px] bg-green-100 text-green-700 px-2 rounded-full transition";
            setTimeout(() => status.className = "text-[10px] bg-gray-100 text-gray-500 px-2 rounded-full transition", 2000);
        }

        function loadState() {
            const saved = localStorage.getItem('turk_planner_data');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    itineraryData = parsed.itinerary;
                    if(parsed.backup) backupSpots = parsed.backup;
                } catch(e) { console.error("Load error", e); }
            }
        }

        function resetToDefault() {
            if(confirm("ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è¨­å®šå—ï¼Ÿ")) {
                itineraryData = JSON.parse(JSON.stringify(defaultItinerary));
                backupSpots = JSON.parse(JSON.stringify(defaultBackup));
                saveState();
                updateAll();
                alert("å·²é‡ç½®");
            }
        }

        // --- SYNC ---
        function exportData() {
            const code = JSON.stringify({ itinerary: itineraryData, backup: backupSpots });
            document.getElementById('sync-title').innerText = "åˆ†äº«è¡Œç¨‹ä»£ç¢¼";
            document.getElementById('sync-desc').innerText = "è¤‡è£½ä»£ç¢¼å‚³çµ¦æœ‹å‹";
            document.getElementById('sync-data').value = code;
            document.getElementById('sync-data').readOnly = true;
            document.getElementById('sync-actions').innerHTML = `<button onclick="copyToClipboard()" class="bg-turk-blue text-white py-2 rounded-lg font-bold">è¤‡è£½ä»£ç¢¼</button>`;
            document.getElementById('sync-modal').classList.remove('hidden');
        }

        function importDataModal() {
            document.getElementById('sync-title').innerText = "åŒ¯å…¥è¡Œç¨‹";
            document.getElementById('sync-desc').innerText = "è²¼ä¸Šæœ‹å‹çš„ä»£ç¢¼";
            const ta = document.getElementById('sync-data');
            ta.value = ""; ta.readOnly = false; ta.placeholder = "è²¼ä¸Šä»£ç¢¼...";
            document.getElementById('sync-actions').innerHTML = `<button onclick="performImport()" class="bg-turk-gold text-white py-2 rounded-lg font-bold">ç¢ºèªåŒ¯å…¥</button>`;
            document.getElementById('sync-modal').classList.remove('hidden');
        }

        function copyToClipboard() {
            const el = document.getElementById("sync-data");
            el.select(); navigator.clipboard.writeText(el.value).then(() => alert("å·²è¤‡è£½ï¼"));
        }

        function performImport() {
            const code = document.getElementById("sync-data").value;
            if(!code) return;
            try {
                const p = JSON.parse(code);
                if(p.itinerary && p.backup) {
                    itineraryData = p.itinerary; backupSpots = p.backup;
                    saveState(); updateAll();
                    document.getElementById('sync-modal').classList.add('hidden');
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                } else alert("æ ¼å¼éŒ¯èª¤");
            } catch(e) { alert("ç„¡æ•ˆä»£ç¢¼"); }
        }

        // --- MAP LOGIC ---
        function initMap() {
            if(map) return;
            map = L.map('map', {zoomControl: false}).setView([41.0082, 28.9784], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â©OpenStreetMap', maxZoom: 19 }).addTo(map);
            map.on('click', function(e) {
                if(isAddMode) {
                    setTempLocation(e.latlng.lat, e.latlng.lng, "å·²é»æ“Šä½ç½®");
                    document.getElementById('name-modal').classList.remove('hidden');
                }
            });
            renderDaySelector();
            updateAll();
        }

        function renderDaySelector() {
            document.getElementById('day-selector').innerHTML = itineraryData.map((day, idx) => `
                <button onclick="loadDay(${idx})" class="day-btn px-4 py-2 rounded-full text-xs font-bold transition flex-shrink-0 ${idx === 0 ? 'bg-turk-blue text-white shadow' : 'bg-white text-gray-500 border border-gray-200'}" data-idx="${idx}">${day.date}</button>
            `).join('');
        }

        function loadDay(idx) {
            currentDayIndex = idx;
            document.querySelectorAll('.day-btn').forEach(btn => {
                const isActive = parseInt(btn.dataset.idx) === idx;
                btn.className = `day-btn px-4 py-2 rounded-full text-xs font-bold transition flex-shrink-0 ${isActive ? 'bg-turk-blue text-white shadow' : 'bg-white text-gray-500 border border-gray-200'}`;
            });
            updateAll();
        }

        function updateAll() {
            activeMarkers.forEach(m => map.removeLayer(m));
            backupMarkers.forEach(m => map.removeLayer(m));
            if(polyline) map.removeLayer(polyline);
            if(tempMarker) map.removeLayer(tempMarker);
            activeMarkers = []; backupMarkers = [];

            const activeSpots = itineraryData[currentDayIndex].spots;
            const latlngs = [];
            
            // Draw Active
            activeSpots.forEach((spot, i) => {
                const icon = L.divIcon({ className: '', html: `<div class='marker-number'>${i+1}</div>`, iconSize: [24,24], iconAnchor: [12,12] });
                const popup = `
                    <div class="text-center p-2 font-serif">
                        <h3 class="font-bold text-turk-red mb-2 text-sm">${spot.name}</h3>
                        <button onclick="removeFromItinerary('${spot.id}')" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs py-1.5 px-3 rounded flex items-center justify-center">
                            <i class="fa-solid fa-arrow-down mr-1"></i> ç§»å›å‚™ç”¨
                        </button>
                    </div>`;
                const m = L.marker([spot.lat, spot.lng], {icon: icon}).addTo(map).bindPopup(popup);
                activeMarkers.push(m);
                latlngs.push([spot.lat, spot.lng]);
            });
            
            if(latlngs.length > 0) {
                polyline = L.polyline(latlngs, {color: '#8B0000', weight: 4, opacity: 0.8}).addTo(map);
                map.fitBounds(polyline.getBounds(), {padding: [50, 50]});
            }

            // Draw Backup
            backupSpots.forEach(spot => {
                const icon = L.divIcon({ className: '', html: `<div class='marker-backup'><i class='fa-solid ${spot.icon || 'fa-map-pin'}'></i></div>`, iconSize: [20,20], iconAnchor: [10,10] });
                const popup = `
                    <div class="text-center p-2 font-serif">
                        <h3 class="font-bold text-gray-700 mb-2 text-sm">${spot.name}</h3>
                        <button onclick="addToItinerary('${spot.id}')" class="w-full bg-turk-blue text-white text-xs py-1.5 px-3 rounded shadow hover:bg-turk-night flex items-center justify-center">
                            <i class="fa-solid fa-plus mr-1"></i> åŠ å…¥è¡Œç¨‹
                        </button>
                    </div>`;
                const m = L.marker([spot.lat, spot.lng], {icon: icon}).addTo(map).bindPopup(popup);
                backupMarkers.push(m);
            });

            // List
            const activeList = document.getElementById('itinerary-list');
            activeList.innerHTML = '';
            activeSpots.forEach((spot, i) => activeList.appendChild(createListItem(spot, i+1)));

            if(activeSortable) activeSortable.destroy();
            activeSortable = new Sortable(activeList, { animation: 150, onEnd: handleDragEnd });
        }

        function createListItem(spot, index) {
            const el = document.createElement('div');
            el.dataset.id = spot.id;
            el.className = 'bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between cursor-grab active:cursor-grabbing';
            el.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="bg-turk-red w-6 h-6 text-white rounded-full flex items-center justify-center text-xs font-bold">${index}</div>
                    <div class="font-bold text-gray-800 text-sm truncate max-w-[200px]">${spot.name}</div>
                </div>
                <div class="text-gray-300"><i class="fa-solid fa-bars"></i></div>
            `;
            el.onclick = () => map.flyTo([spot.lat, spot.lng], 16);
            return el;
        }

        function handleDragEnd() {
            const getIds = (id) => Array.from(document.getElementById(id).children).map(el => el.dataset.id);
            const findSpot = (id) => itineraryData[currentDayIndex].spots.find(x => x.id === id);
            itineraryData[currentDayIndex].spots = getIds('itinerary-list').map(findSpot).filter(Boolean);
            saveState(); updateAll();
        }

        // --- SEARCH/ADD ---
        function toggleAddMode() {
            isAddMode = !isAddMode;
            const btn = document.getElementById('add-mode-btn');
            if(isAddMode) {
                btn.classList.add('bg-turk-gold', 'text-white', 'border-white');
                btn.classList.remove('bg-white', 'text-turk-dark');
                document.getElementById('add-hint').classList.remove('hidden');
                document.getElementById('name-modal').classList.remove('hidden');
                document.getElementById('search-query').value = '';
                document.getElementById('search-results').classList.add('hidden');
                document.getElementById('new-spot-name').value = '';
                tempLatLng = null;
                document.getElementById('location-status').innerHTML = '<i class="fa-solid fa-location-dot"></i> è«‹å…ˆæœå°‹æˆ–é»æ“Šä½ç½®';
                document.getElementById('location-status').className = 'text-[10px] text-gray-400 mt-1 italic';
            } else {
                btn.classList.remove('bg-turk-gold', 'text-white', 'border-white');
                btn.classList.add('bg-white', 'text-turk-dark');
                document.getElementById('add-hint').classList.add('hidden');
                document.getElementById('name-modal').classList.add('hidden');
                if(tempMarker) map.removeLayer(tempMarker);
            }
        }

        async function searchPlace() {
            const query = document.getElementById('search-query').value;
            const resultList = document.getElementById('search-results');
            if(!query) return;
            resultList.innerHTML = '<li class="p-2 text-gray-500">æœå°‹ä¸­...</li>'; resultList.classList.remove('hidden');
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&viewbox=28.0,41.5,30.0,40.5&bounded=1`);
                const data = await res.json();
                resultList.innerHTML = '';
                if(data.length === 0) { resultList.innerHTML = '<li class="p-2 text-red-500">æ‰¾ä¸åˆ°åœ°é»</li>'; }
                else {
                    data.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'p-2 hover:bg-turk-sand cursor-pointer truncate';
                        li.innerText = item.display_name;
                        li.onclick = () => { setTempLocation(item.lat, item.lon, item.display_name.split(',')[0]); resultList.classList.add('hidden'); };
                        resultList.appendChild(li);
                    });
                }
            } catch (e) { resultList.innerHTML = '<li class="p-2 text-red-500">æœå°‹éŒ¯èª¤</li>'; }
        }

        function setTempLocation(lat, lng, name) {
            tempLatLng = { lat: parseFloat(lat), lng: parseFloat(lng) };
            document.getElementById('new-spot-name').value = name;
            const statusEl = document.getElementById('location-status');
            statusEl.innerHTML = '<i class="fa-solid fa-check text-green-500"></i> ä½ç½®å·²é–å®š';
            statusEl.className = 'text-[10px] text-green-600 mt-1 font-bold';
            if(tempMarker) map.removeLayer(tempMarker);
            const icon = L.divIcon({ className: '', html: `<div class='marker-temp'></div>`, iconSize: [20,20], iconAnchor: [10,10] });
            tempMarker = L.marker([lat, lng], {icon: icon}).addTo(map);
            map.flyTo([lat, lng], 15);
        }

        function cancelAddSpot() { toggleAddMode(); }
        function confirmAddSpot() {
            const name = document.getElementById('new-spot-name').value;
            if(name && tempLatLng) {
                backupSpots.push({ id: 'b_'+Date.now(), name: name, lat: tempLatLng.lat, lng: tempLatLng.lng, icon: 'fa-map-pin' });
                toggleAddMode(); saveState(); updateAll();
            } else { alert("è«‹è¼¸å…¥åç¨±ä¸¦ç¢ºèªä½ç½®"); }
        }

        // --- UTILS ---
        function openGoogleRoute() {
            const spots = itineraryData[currentDayIndex].spots;
            if(spots.length < 2) return alert("è‡³å°‘éœ€è¦å…©å€‹åœ°é»");
            const origin = `${spots[0].lat},${spots[0].lng}`;
            const dest = `${spots[spots.length-1].lat},${spots[spots.length-1].lng}`;
            let wp = "";
            if(spots.length > 2) wp = "&waypoints=" + spots.slice(1, -1).map(s => `${s.lat},${s.lng}`).join('|');
            window.open(`https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}${wp}&travelmode=walking`, '_blank');
        }

        let totalSpent = 0;
        function addExpense() { const v = parseFloat(document.getElementById('budget-input').value); if(v) { totalSpent += v; document.getElementById('total-spent').innerText = totalSpent; document.getElementById('budget-input').value = ''; } }
        function resetBudget() { totalSpent = 0; document.getElementById('total-spent').innerText = 0; }
        function calculateRate() { document.getElementById('calc-twd').value = (document.getElementById('calc-try').value * 0.93).toFixed(1); }
        function toggleCurrency() { const el = document.getElementById('currency-sheet'); el.classList.toggle('hidden'); }
        function updateTime() {
            const now = new Date();
            const fmt = (tz) => now.toLocaleTimeString('zh-TW', {timeZone: tz, hour:'2-digit', minute:'2-digit', hour12:false});
            document.getElementById('clock-ist').innerText = fmt("Europe/Istanbul");
            document.getElementById('clock-tpe').innerText = fmt("Asia/Taipei");
            const days = Math.floor((new Date('2025-12-25') - now) / (86400000));
            if(days > 0) document.getElementById('days').innerText = days;
        }

        function switchView(id) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-'+id).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('text-turk-dark', 'active'); el.classList.add('text-gray-400'); });
            document.getElementById('btn-'+id).classList.add('text-turk-dark', 'active');
            if(id === 'planner') setTimeout(() => { initMap(); map.invalidateSize(); }, 100);
            window.scrollTo(0,0);
        }

        document.addEventListener('DOMContentLoaded', () => { 
            loadState(); 
            setInterval(updateTime, 1000); updateTime(); calculateRate(); 
        });
    </script>
</body>
</html>
