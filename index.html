<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼Šæ–¯å¦å ¡å…¨èƒ½åš®å° Pro</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 3. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 4. Leaflet CSS (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- 5. Leaflet JS (Map) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- 6. SortableJS (Drag & Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.css"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'turk-red': '#8B0000',
                        'turk-blue': '#1D5D68', 
                        'turk-gold': '#C5A059',
                        'turk-sand': '#F4EBD9',
                        'turk-night': '#1A202C',
                    },
                    fontFamily: {
                        'serif': ['"Noto Serif TC"', 'serif'],
                        'display': ['"Cinzel"', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F4EBD9;
            font-family: 'Noto Serif TC', serif;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            overscroll-behavior-y: none;
        }

        .pattern-bg {
            background-color: #F4EBD9;
            background-image: 
                radial-gradient(#C5A059 15%, transparent 16%),
                radial-gradient(#C5A059 15%, transparent 16%);
            background-size: 24px 24px;
            background-position: 0 0, 12px 12px;
            opacity: 0.15;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        /* Marker Styles */
        .marker-number {
            background-color: #8B0000;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: sans-serif;
            border: 2px solid white;
            box-shadow: 0 3px 6px rgba(0,0,0,0.4);
            z-index: 100;
        }

        .marker-backup {
            background-color: #9CA3AF; /* Gray */
            opacity: 0.7;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Layout */
        #map {
            height: 40vh; /* Map height */
            width: 100%;
            z-index: 0;
            border-bottom: 4px solid #C5A059;
        }

        .sortable-ghost {
            opacity: 0.4;
            background-color: #F3E5AB;
        }
        
        /* Pulse animation for add mode */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        .pulse-ring {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #C5A059;
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
    </style>
</head>
<body>

    <div class="pattern-bg"></div>

    <!-- Top Info Bar -->
    <div class="fixed top-0 w-full z-50 bg-turk-blue text-white shadow-lg px-4 py-2 flex justify-between items-center h-14">
        <div class="font-display text-turk-gold tracking-widest text-lg">ISTANBUL PRO</div>
        <div class="flex items-center space-x-2 text-right">
            <div id="clock-ist" class="font-bold text-sm font-mono">--:--</div>
        </div>
    </div>

    <!-- ================= VIEW 1: DASHBOARD ================= -->
    <div id="view-dashboard" class="pt-16 px-4 pb-24 space-y-6">
        <div class="bg-gradient-to-r from-turk-night to-turk-blue rounded-xl p-6 text-white text-center shadow-lg relative overflow-hidden">
            <h2 class="text-turk-gold font-display text-xl mb-2">è·é›¢å‡ºç™¼</h2>
            <div class="flex justify-center space-x-4 font-mono">
                <div><span id="days" class="text-3xl font-bold">--</span><div class="text-[10px]">DAYS</div></div>
            </div>
            <button onclick="switchView('planner')" class="mt-4 bg-turk-gold text-white px-6 py-2 rounded-full font-bold shadow hover:bg-yellow-600 transition">
                é–‹å§‹è¦åŠƒè¡Œç¨‹
            </button>
        </div>
        
        <div class="bg-white/90 p-4 rounded-xl border border-turk-gold shadow-sm">
            <h3 class="font-bold text-turk-blue mb-2">ğŸ‡¹ğŸ‡· å¿«é€ŸæŒ‡å—</h3>
            <p class="text-sm text-gray-600">å‰å¾€ã€Œè¡Œç¨‹åœ°åœ–ã€é é¢ï¼Œæ‚¨å¯ä»¥é•·æŒ‰æ‹–æ›³æ™¯é»ä¾†èª¿æ•´é †åºï¼Œæˆ–å°‡æ™¯é»ç§»è‡³ã€Œå‚™ç”¨æ¸…å–®ã€ã€‚é»æ“Šåœ°åœ–ä¸Šçš„ "+" è™Ÿå¯ä»¥æ–°å¢æ‚¨ç™¼ç¾çš„ç§æˆ¿æ™¯é»ã€‚</p>
        </div>
    </div>

    <!-- ================= VIEW 2: MAP & PLANNER (Core) ================= -->
    <div id="view-planner" class="hidden h-screen flex flex-col pt-14">
        
        <!-- Day Selector -->
        <div class="bg-turk-sand overflow-x-auto whitespace-nowrap p-2 shadow-inner z-10 flex space-x-2" id="day-selector">
            <!-- JS populated -->
        </div>

        <!-- Map Area -->
        <div class="relative">
            <div id="map"></div>
            <!-- Add Spot Control -->
            <button onclick="toggleAddMode()" id="add-mode-btn" class="absolute top-4 right-4 z-[400] bg-white text-turk-dark p-2 rounded-lg shadow-lg border-2 border-transparent hover:border-turk-gold transition flex items-center space-x-1">
                <i class="fa-solid fa-location-crosshairs text-lg"></i>
                <span class="text-xs font-bold">æ–°å¢æ™¯é»</span>
            </button>
            <div id="add-hint" class="absolute top-16 right-4 z-[400] bg-turk-gold text-white text-xs px-2 py-1 rounded shadow hidden">
                é»æ“Šåœ°åœ–ä»»æ„è™•æ–°å¢
            </div>
        </div>

        <!-- Draggable Lists Area -->
        <div class="flex-1 bg-white relative rounded-t-2xl -mt-4 z-10 shadow-lg flex flex-col overflow-hidden">
            
            <!-- Sticky Header -->
            <div class="p-3 border-b border-gray-100 flex justify-between items-center bg-white sticky top-0 z-20 shadow-sm">
                <div class="text-xs font-bold text-turk-blue">
                    <i class="fa-solid fa-route mr-1"></i> ä»Šæ—¥è¡Œç¨‹
                </div>
                <button onclick="openGoogleRoute()" class="bg-blue-600 text-white text-xs px-3 py-1.5 rounded-full shadow hover:bg-blue-700 flex items-center">
                    <i class="fa-solid fa-location-arrow mr-1"></i> Google å°èˆª
                </button>
            </div>
            
            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto bg-gray-50 pb-24">
                
                <!-- Active Itinerary List -->
                <div id="itinerary-list" class="p-2 space-y-2 min-h-[100px]">
                    <!-- Items populated by JS -->
                </div>

                <!-- Backup List Header -->
                <div class="px-3 py-2 mt-4 flex items-center justify-between text-gray-500 border-t border-gray-200">
                    <div class="text-xs font-bold flex items-center">
                        <i class="fa-solid fa-box-archive mr-1"></i> å‚™ç”¨æ¸…å–® / é™„è¿‘æ™¯é»
                    </div>
                    <span class="text-[10px] bg-gray-200 px-2 py-0.5 rounded-full">å¯æ‹–æ›³è‡³ä¸Šæ–¹åŠ å…¥è¡Œç¨‹</span>
                </div>

                <!-- Backup List -->
                <div id="backup-list" class="p-2 space-y-2 bg-gray-100/50 min-h-[100px]">
                    <!-- Backup items populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- ================= VIEW 3: GUIDE ================= -->
    <div id="view-guide" class="hidden pt-20 px-4 pb-24 space-y-6">
        <div class="bg-white p-4 rounded-xl border-l-4 border-turk-red shadow-sm">
            <h3 class="font-bold text-turk-red mb-2">ç·Šæ€¥è¯çµ¡</h3>
            <p class="text-sm text-gray-700">è­¦å¯Ÿ: 155 | æ€¥æ•‘: 112</p>
        </div>
    </div>

    <!-- ================= BOTTOM NAV ================= -->
    <nav class="fixed bottom-0 w-full bg-white border-t border-turk-gold/30 shadow-lg h-20 z-50 safe-area-pb">
        <div class="grid grid-cols-3 h-full pb-2">
            <button onclick="switchView('dashboard')" class="nav-item active flex flex-col items-center justify-center text-turk-dark" id="btn-dashboard">
                <i class="fa-solid fa-house text-xl mb-1"></i>
                <span class="text-[10px] font-bold">é¦–é </span>
            </button>
            <button onclick="switchView('planner')" class="nav-item flex flex-col items-center justify-center text-gray-400" id="btn-planner">
                <div class="bg-turk-red text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg -mt-6 border-4 border-turk-sand">
                    <i class="fa-solid fa-map text-lg"></i>
                </div>
                <span class="text-[10px] font-bold mt-1">è¡Œç¨‹åœ°åœ–</span>
            </button>
            <button onclick="switchView('guide')" class="nav-item flex flex-col items-center justify-center text-gray-400" id="btn-guide">
                <i class="fa-solid fa-book-open text-xl mb-1"></i>
                <span class="text-[10px] font-bold">æ”»ç•¥</span>
            </button>
        </div>
    </nav>

    <!-- Modal: Add Spot Name -->
    <div id="name-modal" class="fixed inset-0 z-[1000] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-80">
            <h3 class="font-bold text-turk-dark mb-4">æ–°å¢è‡ªè¨‚æ™¯é»</h3>
            <input type="text" id="new-spot-name" placeholder="è¼¸å…¥æ™¯é»åç¨±..." class="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-turk-blue outline-none">
            <div class="flex justify-end space-x-2">
                <button onclick="cancelAddSpot()" class="px-4 py-2 text-gray-500 text-sm">å–æ¶ˆ</button>
                <button onclick="confirmAddSpot()" class="px-4 py-2 bg-turk-blue text-white rounded text-sm font-bold">åŠ å…¥å‚™ç”¨æ¸…å–®</button>
            </div>
        </div>
    </div>

    <!-- Script Logic -->
    <script>
        // --- 1. DATA ---
        
        // Active Itinerary (Grouped by Date)
        const itineraryData = [
            {
                date: "12/26",
                spots: [
                    { id: "s1", name: "ä¼Šæ–¯å¦å ¡æ©Ÿå ´ (IST)", lat: 41.261, lng: 28.742, icon: "fa-plane" },
                    { id: "s2", name: "JW Marriott Bosphorus", lat: 41.025, lng: 28.977, icon: "fa-hotel" }
                ]
            },
            {
                date: "12/27",
                spots: [
                    { id: "s5", name: "è–ç´¢è²äºå¤§æ¸…çœŸå¯º", lat: 41.0086, lng: 28.9802, icon: "fa-mosque" },
                    { id: "s6", name: "è—è‰²æ¸…çœŸå¯º", lat: 41.0054, lng: 28.9768, icon: "fa-mosque" },
                    { id: "s8", name: "åœ°ä¸‹æ°´å®®æ®¿", lat: 41.0084, lng: 28.9779, icon: "fa-water" }
                ]
            },
            {
                date: "12/28",
                spots: [
                    { id: "s11", name: "å¤§å·´æ‰ (Grand Bazaar)", lat: 41.0107, lng: 28.9680, icon: "fa-bag-shopping" },
                    { id: "s12", name: "é¦™æ–™å¸‚å ´", lat: 41.0165, lng: 28.9705, icon: "fa-pepper-hot" }
                ]
            },
            {
                date: "12/29",
                spots: [
                    { id: "s14", name: "Kabatas ç¢¼é ­", lat: 41.0345, lng: 28.9934, icon: "fa-ship" },
                    { id: "s15", name: "Buyukada (å¤§å³¶)", lat: 40.8738, lng: 29.1276, icon: "fa-umbrella-beach" }
                ]
            },
            {
                date: "12/30",
                spots: [
                    { id: "s16", name: "Taksim å»£å ´", lat: 41.0370, lng: 28.9850, icon: "fa-flag" },
                    { id: "s18", name: "åŠ æ‹‰é”å¡”", lat: 41.0256, lng: 28.9741, icon: "fa-tower-observation" }
                ]
            },
            {
                date: "12/31",
                spots: [
                    { id: "s21", name: "Kadikoy (äºæ´²å€)", lat: 40.990, lng: 29.025, icon: "fa-map-pin" },
                    { id: "s23", name: "Orientbank Hotel", lat: 41.0163, lng: 28.9744, icon: "fa-champagne-glasses" }
                ]
            },
             {
                date: "01/01",
                spots: [
                    { id: "s24", name: "è˜‡èŠæ›¼å°¼è€¶æ¸…çœŸå¯º", lat: 41.0162, lng: 28.9638, icon: "fa-mosque" },
                    { id: "s25", name: "Balat å½©è‰²è¡—å€", lat: 41.0315, lng: 28.9472, icon: "fa-camera" }
                ]
            }
        ];

        // Global Backup List (Shared across all days)
        let backupSpots = [
            { id: "b1", name: "æ‰˜æ™®å¡åŒ¹çš‡å®® (å‚™ç”¨)", lat: 41.0115, lng: 28.9833, icon: "fa-crown" },
            { id: "b2", name: "è€ƒå¤åšç‰©é¤¨ (å‚™ç”¨)", lat: 41.0116, lng: 28.9813, icon: "fa-landmark" },
            { id: "b3", name: "å½©è™¹éšæ¢¯ (å‚™ç”¨)", lat: 41.0326, lng: 28.9863, icon: "fa-stairs" }
        ];

        // State
        let currentDayIndex = 0;
        let map = null;
        let activeMarkers = [];
        let backupMarkers = [];
        let polyline = null;
        let activeSortable = null;
        let backupSortable = null;
        let isAddMode = false;
        let tempLatLng = null;

        // --- 2. MAP & CORE LOGIC ---

        function initMap() {
            if(map) return;
            map = L.map('map', {zoomControl: false}).setView([41.0082, 28.9784], 13);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: 'Â©OpenStreetMap',
                maxZoom: 19
            }).addTo(map);

            // Map Click Event for Adding Spots
            map.on('click', function(e) {
                if(isAddMode) {
                    tempLatLng = e.latlng;
                    document.getElementById('name-modal').classList.remove('hidden');
                    document.getElementById('new-spot-name').focus();
                }
            });

            renderDaySelector();
            loadDay(0);
        }

        function renderDaySelector() {
            const container = document.getElementById('day-selector');
            container.innerHTML = itineraryData.map((day, idx) => `
                <button onclick="loadDay(${idx})" 
                    class="day-btn px-4 py-2 rounded-full text-xs font-bold transition flex-shrink-0 ${idx === 0 ? 'bg-turk-blue text-white shadow' : 'bg-white text-gray-500 border border-gray-200'}" 
                    data-idx="${idx}">
                    ${day.date}
                </button>
            `).join('');
        }

        function loadDay(idx) {
            currentDayIndex = idx;
            
            // UI Styling for Buttons
            document.querySelectorAll('.day-btn').forEach(btn => {
                if(parseInt(btn.dataset.idx) === idx) {
                    btn.className = 'day-btn px-4 py-2 rounded-full text-xs font-bold transition flex-shrink-0 bg-turk-blue text-white shadow';
                } else {
                    btn.className = 'day-btn px-4 py-2 rounded-full text-xs font-bold transition flex-shrink-0 bg-white text-gray-500 border border-gray-200';
                }
            });

            updateAll();
        }

        function updateAll() {
            renderLists();
            drawMap();
        }

        // --- MAP DRAWING ---
        function drawMap() {
            const activeSpots = itineraryData[currentDayIndex].spots;

            // 1. Clear Active Layers
            activeMarkers.forEach(m => map.removeLayer(m));
            if(polyline) map.removeLayer(polyline);
            activeMarkers = [];

            // 2. Clear Backup Layers
            backupMarkers.forEach(m => map.removeLayer(m));
            backupMarkers = [];

            const latlngs = [];

            // 3. Draw Active Spots (Bold, Numbered, Connected)
            activeSpots.forEach((spot, i) => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class='marker-number'>${i+1}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                const marker = L.marker([spot.lat, spot.lng], {icon: icon})
                    .addTo(map)
                    .bindPopup(`<b>${spot.name}</b>`);
                
                activeMarkers.push(marker);
                latlngs.push([spot.lat, spot.lng]);
            });

            // 4. Draw Route Line
            if(latlngs.length > 0) {
                polyline = L.polyline(latlngs, {color: '#1D5D68', weight: 4, opacity: 0.8}).addTo(map);
                map.fitBounds(polyline.getBounds(), {padding: [50, 50]});
            }

            // 5. Draw Backup Spots (Faded, Ghost Dots)
            backupSpots.forEach((spot) => {
                const icon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class='marker-backup'></div>`, // Simple gray dot
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                const marker = L.marker([spot.lat, spot.lng], {icon: icon})
                    .addTo(map)
                    .bindPopup(`<span class="text-gray-500 font-bold">${spot.name} (å‚™ç”¨)</span>`);
                
                backupMarkers.push(marker);
            });
        }

        // --- LIST RENDERING & DRAG DROP ---
        function renderLists() {
            const activeListEl = document.getElementById('itinerary-list');
            const backupListEl = document.getElementById('backup-list');
            
            activeListEl.innerHTML = '';
            backupListEl.innerHTML = '';

            // Render Active Items
            itineraryData[currentDayIndex].spots.forEach((spot, i) => {
                const el = createListItem(spot, i + 1, true);
                activeListEl.appendChild(el);
            });

            // Render Backup Items
            backupSpots.forEach((spot) => {
                const el = createListItem(spot, null, false);
                backupListEl.appendChild(el);
            });

            // Initialize Sortable (Active List)
            if(activeSortable) activeSortable.destroy();
            activeSortable = new Sortable(activeListEl, {
                group: 'shared', // Allow drag between lists
                animation: 150,
                onEnd: handleDragEnd
            });

            // Initialize Sortable (Backup List)
            if(backupSortable) backupSortable.destroy();
            backupSortable = new Sortable(backupListEl, {
                group: 'shared',
                animation: 150,
                sort: false, // Optional: disable sorting within backup if desired
                onEnd: handleDragEnd
            });
        }

        function createListItem(spot, index, isActive) {
            const el = document.createElement('div');
            el.className = isActive 
                ? 'bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex items-center justify-between cursor-grab active:cursor-grabbing mb-2'
                : 'bg-white/60 p-2 rounded-lg border border-dashed border-gray-300 flex items-center justify-between cursor-grab active:cursor-grabbing opacity-80 hover:opacity-100 mb-2';
            
            el.dataset.id = spot.id;
            
            const iconHtml = isActive 
                ? `<div class="w-6 h-6 bg-turk-red text-white rounded-full flex items-center justify-center text-xs font-bold mr-3">${index}</div>`
                : `<div class="w-6 h-6 bg-gray-300 text-white rounded-full flex items-center justify-center text-xs font-bold mr-3"><i class="fa-solid fa-box-archive"></i></div>`;

            el.innerHTML = `
                <div class="flex items-center">
                    ${iconHtml}
                    <div>
                        <div class="font-bold text-gray-800 text-sm">${spot.name}</div>
                        ${isActive ? '<div class="text-[10px] text-turk-blue">ç›®å‰è¡Œç¨‹</div>' : '<div class="text-[10px] text-gray-500">å‚™ç”¨æ¸…å–®</div>'}
                    </div>
                </div>
                <div class="text-gray-300"><i class="fa-solid fa-grip-lines"></i></div>
            `;
            
            // Click to pan map
            el.addEventListener('click', () => {
                map.flyTo([spot.lat, spot.lng], 16);
            });

            return el;
        }

        function handleDragEnd(evt) {
            // Need to synchronize DOM changes with Data Arrays
            const activeListEl = document.getElementById('itinerary-list');
            const backupListEl = document.getElementById('backup-list');

            // Reconstruct Active Array from DOM order
            const newActiveIds = Array.from(activeListEl.children).map(el => el.dataset.id);
            const newBackupIds = Array.from(backupListEl.children).map(el => el.dataset.id);

            // Helper to find spot object from ID (searching both source arrays)
            const findSpot = (id) => {
                let found = itineraryData[currentDayIndex].spots.find(s => s.id === id);
                if(!found) found = backupSpots.find(s => s.id === id);
                return found;
            }

            // Build new arrays
            const newActiveSpots = newActiveIds.map(id => findSpot(id)).filter(Boolean);
            const newBackupSpots = newBackupIds.map(id => findSpot(id)).filter(Boolean);

            // Update Global State
            itineraryData[currentDayIndex].spots = newActiveSpots;
            backupSpots = newBackupSpots;

            // Re-render everything to update UI (numbers, colors) and Map
            updateAll();
        }


        // --- 3. ADD SPOT FUNCTIONALITY ---

        function toggleAddMode() {
            isAddMode = !isAddMode;
            const btn = document.getElementById('add-mode-btn');
            const hint = document.getElementById('add-hint');
            
            if(isAddMode) {
                btn.classList.add('bg-turk-gold', 'text-white', 'border-white');
                btn.classList.remove('bg-white', 'text-turk-dark');
                hint.classList.remove('hidden');
                document.body.style.cursor = 'crosshair';
            } else {
                btn.classList.remove('bg-turk-gold', 'text-white', 'border-white');
                btn.classList.add('bg-white', 'text-turk-dark');
                hint.classList.add('hidden');
                document.body.style.cursor = 'default';
            }
        }

        function cancelAddSpot() {
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('new-spot-name').value = '';
            toggleAddMode(); // Turn off mode
        }

        function confirmAddSpot() {
            const name = document.getElementById('new-spot-name').value;
            if(!name) return;

            const newSpot = {
                id: 'b_' + Date.now(), // unique ID
                name: name,
                lat: tempLatLng.lat,
                lng: tempLatLng.lng,
                icon: 'fa-map-pin'
            };

            // Add to Backup List by default
            backupSpots.push(newSpot);
            
            // Reset
            document.getElementById('name-modal').classList.add('hidden');
            document.getElementById('new-spot-name').value = '';
            toggleAddMode();
            
            // Refresh
            updateAll();
            
            // Show confirmation toast (simple alert for now)
            // alert('å·²åŠ å…¥å‚™ç”¨æ¸…å–®');
        }

        // --- 4. UTILS ---

        function openGoogleRoute() {
            const spots = itineraryData[currentDayIndex].spots;
            if (spots.length < 2) {
                alert("ä»Šæ—¥è¡Œç¨‹è‡³å°‘éœ€è¦å…©å€‹åœ°é»æ‰èƒ½å°èˆª");
                return;
            }
            const origin = `${spots[0].lat},${spots[0].lng}`;
            const destination = `${spots[spots.length-1].lat},${spots[spots.length-1].lng}`;
            let waypoints = "";
            if (spots.length > 2) {
                const intermediate = spots.slice(1, spots.length - 1);
                waypoints = "&waypoints=" + intermediate.map(s => `${s.lat},${s.lng}`).join('|');
            }
            const url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}${waypoints}&travelmode=walking`;
            window.open(url, '_blank');
        }

        function updateClocks() {
            const now = new Date();
            const ist = new Date(now.toLocaleString("en-US", {timeZone: "Europe/Istanbul"}));
            document.getElementById('clock-ist').innerText = ist.toLocaleTimeString('zh-TW', {hour:'2-digit', minute:'2-digit', hour12:false});
            
            // Countdown
            const target = new Date('2025-12-25T09:25:00').getTime();
            const diff = target - now.getTime();
            if(diff > 0) {
                document.getElementById('days').innerText = Math.floor(diff / (1000 * 60 * 60 * 24));
            }
        }

        function switchView(viewId) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + viewId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('text-turk-dark', 'active');
                el.classList.add('text-gray-400');
            });
            document.getElementById('btn-' + viewId).classList.add('text-turk-dark', 'active');
            
            if(viewId === 'planner') {
                setTimeout(() => {
                    initMap();
                    map.invalidateSize();
                }, 100);
            }
            window.scrollTo(0,0);
        }

        document.addEventListener('DOMContentLoaded', () => {
            setInterval(updateClocks, 1000);
            updateClocks();
        });

    </script>
</body>
</html>
