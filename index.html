<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequence Playback Controls</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 10px;
        }
        .controls {
            margin-bottom: 20px;
        }
        .playlist-item {
            margin-bottom: 10px;
        }
        button {
            padding: 10px;
            margin-right: 10px;
            font-size: 16px;
        }
        input[type="range"], input[type="number"], select {
            margin: 5px 0;
            width: 100%;
        }
        label {
            font-size: 16px;
        }
        .loading {
            font-size: 18px;
            color: blue;
            margin-top: 10px;
        }
    </style>
    <script src="https://unpkg.com/audio-buffer-to-wav"></script>
</head>
<body>
    <h1>Sequence Playback Controls</h1>
    <div class="controls">
        <h2>頻率 A 設置</h2>
        <label for="freqA-type">波形：</label>
        <select id="freqA-type">
            <option value="sine">正弦波</option>
            <option value="square">方波</option>
            <option value="triangle">三角波</option>
        </select>
        <br>
        <label for="freqA-freq">頻率 (Hz)：</label>
        <input type="number" id="freqA-freq" min="0.5" max="5000" step="0.1" value="440">
    </div>
    <div class="controls">
        <h2>頻率 B 設置</h2>
        <label for="freqB-type">波形：</label>
        <select id="freqB-type">
            <option value="sine">正弦波</option>
            <option value="square">方波</option>
            <option value="triangle">三角波</option>
        </select>
        <br>
        <label for="freqB-freq">頻率 (Hz)：</label>
        <input type="number" id="freqB-freq" min="0.5" max="5000" step="0.1" value="440">
    </div>
    <div class="controls">
        <label for="duration">播放時長 (秒)：</label>
        <input type="number" id="duration" min="0.1" step="0.1" value="33">
        <br>
        <button id="add-to-playlist">添加到播放列表</button>
    </div>
    <div>
        <h2>播放列表</h2>
        <div id="playlist"></div>
    </div>
    <div>
        <button id="play">播放</button>
        <button id="download">下載</button>
    </div>
    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let playlist = [];

        function addToPlaylist() {
            const typeA = document.getElementById('freqA-type').value;
            const freqA = parseFloat(document.getElementById('freqA-freq').value);
            const typeB = document.getElementById('freqB-type').value;
            const freqB = parseFloat(document.getElementById('freqB-freq').value);
            const duration = parseFloat(document.getElementById('duration').value);
            if (isNaN(freqA) || isNaN(freqB) || isNaN(duration) || freqA < 0.5 || freqA > 5000 || freqB < 0.5 || freqB > 5000 || duration <= 0) {
                alert('輸入無效，請檢查頻率和時長');
                return;
            }
            const item = { typeA, freqA, typeB, freqB, duration };
            playlist.push(item);
            const itemDiv = document.createElement('div');
            itemDiv.className = 'playlist-item';
            itemDiv.textContent = `頻率A: ${typeA} ${freqA}Hz, 頻率B: ${typeB} ${freqB}Hz, 時長: ${duration}秒`;
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '刪除';
            deleteBtn.onclick = () => {
                const index = playlist.indexOf(item);
                if (index > -1) {
                    playlist.splice(index, 1);
                }
                itemDiv.remove();
            };
            itemDiv.appendChild(deleteBtn);
            document.getElementById('playlist').appendChild(itemDiv);
        }

        function playPlaylist() {
            if (playlist.length === 0) {
                alert('播放列表為空');
                return;
            }
            let currentTime = audioContext.currentTime;
            playlist.forEach((item, index) => {
                const oscA = audioContext.createOscillator();
                oscA.type = item.typeA;
                oscA.frequency.setValueAtTime(item.freqA, currentTime);
                oscA.connect(audioContext.destination);
                oscA.start(currentTime);
                oscA.stop(currentTime + item.duration);

                const oscB = audioContext.createOscillator();
                oscB.type = item.typeB;
                oscB.frequency.setValueAtTime(item.freqB, currentTime);
                oscB.connect(audioContext.destination);
                oscB.start(currentTime);
                oscB.stop(currentTime + item.duration);

                currentTime += item.duration + 0.5; // 每個頻率組後停頓0.5秒
            });
        }

        function downloadPlaylist() {
            if (playlist.length === 0) {
                alert('播放列表為空');
                return;
            }
            const pauseDuration = 0.5; // 每個頻率組後的停頓時間
            const totalDuration = playlist.reduce((sum, item) => sum + item.duration, 0) + (playlist.length - 1) * pauseDuration;
            const sampleRate = audioContext.sampleRate;
            const offlineContext = new OfflineAudioContext(2, totalDuration * sampleRate, sampleRate);
            let currentTime = 0;
            playlist.forEach((item, index) => {
                const oscA = offlineContext.createOscillator();
                oscA.type = item.typeA;
                oscA.frequency.setValueAtTime(item.freqA, currentTime);
                oscA.connect(offlineContext.destination);
                oscA.start(currentTime);
                oscA.stop(currentTime + item.duration);

                const oscB = offlineContext.createOscillator();
                oscB.type = item.typeB;
                oscB.frequency.setValueAtTime(item.freqB, currentTime);
                oscB.connect(offlineContext.destination);
                oscB.start(currentTime);
                oscB.stop(currentTime + item.duration);

                if (index < playlist.length - 1) {
                    currentTime += item.duration + pauseDuration;
                } else {
                    currentTime += item.duration;
                }
            });
            const loading = document.createElement('div');
            loading.className = 'loading';
            loading.textContent = '正在渲染音訊...';
            document.body.appendChild(loading);
            offlineContext.startRendering().then(renderedBuffer => {
                const wav = audioBufferToWav(renderedBuffer);
                const blob = new Blob([wav], { type: 'audio/wav' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'playlist.wav';
                a.click();
                URL.revokeObjectURL(url);
                document.body.removeChild(loading);
            });
        }

        document.getElementById('add-to-playlist').addEventListener('click', addToPlaylist);
        document.getElementById('play').addEventListener('click', playPlaylist);
        document.getElementById('download').addEventListener('click', downloadPlaylist);
    </script>
</body>
</html>
